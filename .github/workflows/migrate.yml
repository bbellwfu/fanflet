name: Database Migrations

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - '.github/workflows/migrate.yml'
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Select project ref
        id: project
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ref=${{ secrets.SUPABASE_PROD_PROJECT_REF }}" >> "$GITHUB_OUTPUT"
            echo "env=production" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ secrets.SUPABASE_DEV_PROJECT_REF }}" >> "$GITHUB_OUTPUT"
            echo "env=staging" >> "$GITHUB_OUTPUT"
          fi

      - name: Link Supabase project
        run: supabase link --project-ref ${{ steps.project.outputs.ref }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Reconcile remote migration history
        run: |
          # Get local migration versions from filenames
          LOCAL_VERSIONS=$(ls supabase/migrations/*.sql 2>/dev/null | sed 's/.*\///' | sed 's/_.*//' | sort)
          echo "Local versions:"
          echo "$LOCAL_VERSIONS"

          # Get remote migration versions (table output — extract 14-digit numbers)
          RAW=$(supabase migration list 2>&1 || true)
          echo "Raw migration list output:"
          echo "$RAW"
          REMOTE_VERSIONS=$(echo "$RAW" | grep -oE '[0-9]{14}' | sort -u || true)
          echo "Remote versions:"
          echo "$REMOTE_VERSIONS"

          # Find remote versions that have no local file — mark them as reverted
          ORPHANS=""
          for v in $REMOTE_VERSIONS; do
            if ! echo "$LOCAL_VERSIONS" | grep -q "^${v}$"; then
              ORPHANS="$ORPHANS $v"
            fi
          done

          if [ -n "$ORPHANS" ]; then
            echo "Repairing orphan remote migrations:$ORPHANS"
            supabase migration repair --status reverted $ORPHANS
          else
            echo "No orphan migrations to repair"
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Apply migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Summary
        run: echo "✅ Migrations applied to **${{ steps.project.outputs.env }}** (${{ steps.project.outputs.ref }})" >> "$GITHUB_STEP_SUMMARY"
